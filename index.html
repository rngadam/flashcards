<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="top-bar">
      <div id="top-notification" class="hidden"></div>
      <div id="top-left-controls">
        <div id="skill-selector-checkboxes" class="column-checkbox-group">
            <!-- Skill checkboxes will be populated here by JS -->
        </div>
        <div id="skill-selector-filter" class="column-checkbox-group">
            <button id="filter-toggle-button" class="filter-toggle-button" title="Enable/Disable Word Filter">Filter</button><span id="filter-status-indicator" class="filter-status"></span>
        </div>
      </div>
      <div class="desktop-only-buttons">
        <button id="login-button">Login</button>
        <div id="user-profile" class="hidden">
            <span id="user-display-name"></span>
            <button id="logout-button">Logout</button>
        </div>
        <button id="dashboard-button">üìä</button>
        <button id="history-button">üìú</button>
        <button id="settings-button">‚öôÔ∏è</button>
        <button id="help-button">?</button>
        <button id="fullscreen-button">‚õ∂</button>
      </div>
      <button id="hamburger-menu" class="mobile-only-button">‚ò∞</button>
    </div>

    <div id="mobile-menu-overlay" class="modal-overlay hidden">
        <div id="mobile-menu-panel">
            <div id="mobile-skill-selector-container">
                <label>Skills:</label>
                <div id="mobile-skill-selector-checkboxes" class="column-checkbox-group">
                    <!-- Mobile skill checkboxes will be populated here -->
                </div>
                <div id="mobile-skill-selector-filter" class="column-checkbox-group">
                    <button id="mobile-filter-toggle-button" class="filter-toggle-button" title="Enable/Disable Word Filter">Filter</button><span id="mobile-filter-status-indicator" class="filter-status"></span>
                </div>
            </div>
            <button id="mobile-dashboard-button">üìä Dashboard</button>
            <button id="mobile-history-button">üìú History</button>
            <button id="mobile-settings-button">‚öôÔ∏è Settings</button>
            <div id="mobile-user-profile" class="hidden">
                <span id="mobile-user-display-name"></span>
                <button id="mobile-logout-button">Logout</button>
            </div>
            <button id="mobile-login-button">Login</button>
            <button id="mobile-help-button">? Help</button>
            <button id="mobile-fullscreen-button">‚õ∂ Fullscreen</button>
            <button id="close-mobile-menu-button">Close</button>
        </div>
    </div>

    <div id="dashboard-modal" class="modal-overlay hidden">
        <div id="dashboard-panel">
            <button id="close-dashboard-button">X</button>
            <h2>Dashboard</h2>
            <div class="tabs" role="tablist">
                <button class="tab-button active" id="dashboard-planning-tab" data-tab="dashboard-planning" role="tab" aria-controls="dashboard-planning" aria-selected="true">Planning</button>
                <button class="tab-button" id="dashboard-learning-tab" data-tab="dashboard-learning" role="tab" aria-controls="dashboard-learning" aria-selected="false">Learning</button>
                <button class="tab-button" id="dashboard-words-tab" data-tab="dashboard-words" role="tab" aria-controls="dashboard-words" aria-selected="false">Word Lists</button>
            </div>

            <div id="dashboard-planning" class="tab-panel active" role="tabpanel" aria-labelledby="dashboard-planning-tab">
                <h3>Upcoming Reviews</h3>
                <p>Number of items due for review in the future.</p>
                <div id="planning-buckets"></div>
            </div>

            <div id="dashboard-learning" class="tab-panel" role="tabpanel" aria-labelledby="dashboard-learning-tab">
                <h3>Learning Statistics</h3>
                <div id="learning-summary"></div>
                <h4>Card-specific timing (5-number summary in ms)</h4>
                <div id="card-timing-summary"></div>
            </div>

            <div id="dashboard-words" class="tab-panel" role="tabpanel" aria-labelledby="dashboard-words-tab">
                <div class="dashboard-section">
                    <h3>Mastered Words (Score > 5)</h3>
                    <ul id="mastered-words-list"></ul>
                </div>
                <div class="dashboard-section">
                    <h3>Difficult Words (High views, low score)</h3>
                    <ul id="difficult-words-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay hidden">
        <div id="help-panel">
            <button id="close-help-button">X</button>
            <h2>How to Use Flashcards</h2>
            <p>Follow these steps to get started:</p>
            <ol>
                <li><strong>Load Data:</strong>
                    <ul>
                        <li>Go to <strong>Settings (‚öôÔ∏è)</strong>.</li>
                        <li>Find the "Data Source URL" field.</li>
                        <li>Paste the URL of your TSV or CSV file (e.g., a published Google Sheet).</li>
                        <li>Click <strong>Load</strong>. The app will fetch and parse your data.</li>
                    </ul>
                </li>
                <li><strong>Configure Columns:</strong>
                    <ul>
                        <li>Once data is loaded, the app will show the columns it found.</li>
                        <li>In the "Column Roles" section, assign roles like 'Target Language' and 'Base Language' to your columns.</li>
                        <li>Click <strong>Auto-Configure Skill Settings</strong> to automatically set up practice modes based on your roles.</li>
                    </ul>
                </li>
                <li><strong>Select Skills:</strong>
                    <ul>
                        <li>Go to the <strong>Skills</strong> tab.</li>
                        <li>Check the boxes for the skills you want to practice (e.g., Reading, Writing).</li>
                        <li>You can further customize which columns appear on the front and back of the card for each skill.</li>
                    </ul>
                </li>
                <li><strong>Name and Save:</strong>
                    <ul>
                        <li>Give your configuration a name (e.g., "Spanish Chapter 1").</li>
                        <li>Click <strong>Save Configuration</strong>.</li>
                    </ul>
                </li>
                <li><strong>Start Practicing:</strong>
                    <ul>
                        <li>Close the settings panel.</li>
                        <li>Use the buttons or keyboard shortcuts (displayed on desktop) to navigate, flip cards, and mark them as known or unknown.</li>
                        <li>The app uses a spaced repetition system to show you cards at optimal intervals for learning.</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay hidden">
      <div id="history-panel">
        <button id="close-history-button">X</button>
        <h2>History</h2>
        <div id="history-table-container"></div>
      </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
      <div id="settings">
        <button id="close-settings-button">X</button>
        <h2>Settings</h2>

        <div class="setting">
            <label for="config-name">Configuration Name:</label>
            <input type="text" id="config-name" placeholder="e.g., Spanish Vocabulary">
        </div>

        <div class="setting">
          <label for="config-selector">Load Configuration:</label>
          <select id="config-selector"></select>
        </div>

        <div class="setting data-source-setting">
          <label for="data-url">Data Source URL (TSV/CSV):</label>
          <div class="input-with-button">
            <input type="text" id="data-url" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRE9DYOw1a9S-9Q1ZMXQ7K5HynHhvq9z5KbuqbDgiDwGtV7850pLDHHcBAa-BldfbxqN8Axni0NwjEE/pub?gid=272537463&single=true&output=tsv">
            <button id="load-data">Load</button>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab-button active" id="basic-tab" data-tab="basic-settings" role="tab" aria-controls="basic-settings" aria-selected="true">Basic</button>
          <button class="tab-button" id="skills-tab" data-tab="skills-settings" role="tab" aria-controls="skills-settings" aria-selected="false">Skills</button>
          <button class="tab-button" id="advanced-tab" data-tab="advanced-settings" role="tab" aria-controls="advanced-settings" aria-selected="false">Advanced</button>
          <button class="tab-button" id="filter-tab" data-tab="filter-settings" role="tab" aria-controls="filter-settings" aria-selected="false">Filter</button>
          <button class="tab-button" id="backup-tab" data-tab="backup-settings" role="tab" aria-controls="backup-settings" aria-selected="false">Backup</button>
          <button class="tab-button" id="dangerous-tab" data-tab="dangerous-settings" role="tab" aria-controls="dangerous-settings" aria-selected="false">Dangerous</button>
        </div>

        <div id="basic-settings" class="tab-panel active" role="tabpanel" aria-labelledby="basic-tab">
            <div class="setting" id="column-roles-container">
                 <!-- Master column role configuration will be generated here by JS -->
            </div>
            <div class="setting">
                <label for="font-selector">Font:</label>
                <select id="font-selector">
                    <option value="Arial">Arial</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
        </div>

        <div id="skills-settings" class="tab-panel" role="tabpanel" aria-labelledby="skills-tab">
            <div id="skills-list-container">
                <div class="skills-toolbar">
                    <button id="add-skill-button">Add New Skill</button>
                    <button id="preset-skills-button">Load Preset Skills</button>
                    <button id="export-skills-button">Export Skills</button>
                    <button id="delete-all-skills-button" class="danger">Delete All Skills</button>
                </div>
                <div id="skills-list">
                    <!-- User-defined skills will be dynamically added here -->
                </div>
            </div>
        </div>

        <div id="advanced-settings" class="tab-panel" role="tabpanel" aria-labelledby="advanced-tab">
            <div class="setting">
                <label for="tts-rate">Target Language Reading Speed:</label>
                <input type="range" id="tts-rate" min="0.1" max="2" value="1" step="0.1">
            </div>
            <div class="setting">
                <label for="tts-rate-base">Base Language Reading Speed:</label>
                <input type="range" id="tts-rate-base" min="0.1" max="3" value="1.5" step="0.1">
            </div>
            <div class="setting">
                <input type="checkbox" id="disable-animation">
                <label for="disable-animation">Disable Flip Animation</label>
            </div>
            <div class="setting">
                <label for="repetition-intervals">Repetition Intervals (seconds, comma-separated):</label>
                <textarea id="repetition-intervals" rows="3"></textarea>
            </div>
            <div class="setting">
                <label for="multiple-choice-count">Number of Multiple Choice Options:</label>
                <input type="number" id="multiple-choice-count" min="2" max="10" value="4">
            </div>
            <div class="setting">
                <label for="voice-correct-delay">Correct Answer Delay (ms):</label>
                <input type="number" id="voice-correct-delay" min="0" step="100" value="1000">
            </div>
        </div>

        <div id="filter-settings" class="tab-panel" role="tabpanel" aria-labelledby="filter-tab">
            <div class="setting">
                <input type="checkbox" id="enable-filter-settings-checkbox">
                <label for="enable-filter-settings-checkbox">Enable Filter</label>
            </div>
            <div class="setting" id="filter-text-container">
                <label for="filter-text">Text to Filter by:</label>
                <div class="highlight-container">
                    <div id="filter-highlight-layer" class="highlight-layer"></div>
                    <textarea id="filter-text" rows="5" placeholder="Paste text here..."></textarea>
                </div>
                <small>The deck will only show cards where the 'Target Language' column contains a word from this text.</small>
            </div>
            <div class="setting">
                <div id="filter-intersection-info">Found 0 matching words in the deck.</div>
            </div>
            <div class="setting">
                <input type="checkbox" id="filter-allow-overflow" checked>
                <label for="filter-allow-overflow">Allow other cards after filtered set is learned</label>
            </div>
            <div class="button-container">
                <button id="apply-filter-button">Apply</button>
                <button id="clear-filter-button" class="danger">Clear</button>
            </div>
        </div>

        <div id="backup-settings" class="tab-panel" role="tabpanel" aria-labelledby="backup-tab">
            <div class="setting">
                <p>Save or load a full backup of all configurations and card statistics.</p>
                <button id="export-all-data-button">Export All Data (JSON)</button>
                <button id="import-all-data-button">Import from Backup (JSON)</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
            <div class="setting">
                <p>Export all card and skill data to a portable SQLite database file for external analysis.</p>
                <button id="export-sqlite-button">Export to SQLite (.db)</button>
            </div>
        </div>

        <div id="dangerous-settings" class="tab-panel" role="tabpanel" aria-labelledby="dangerous-tab">
            <div class="setting">
                <p>This action cannot be undone.</p>
                <button id="reset-stats" class="danger">Reset Current Deck Stats</button>
            </div>
        </div>

        <div class="button-container">
            <button id="save-config">Save As New...</button>
        </div>
        <div id="cache-status"></div>
      </div>
    </div>

    <div id="login-modal" class="modal-overlay hidden">
        <div id="login-panel">
            <button id="close-login-modal-button">X</button>
            <h2>Login</h2>
            <p id="login-blurb">Log in to keep your learning progress and settings synchronized across all your devices.</p>
            <p>Choose a provider to log in with:</p>
            <div id="login-providers" class="login-buttons">
                <!-- Login buttons will be dynamically populated here by JS -->
            </div>
        </div>
    </div>

    <div id="skill-config-modal" class="modal-overlay hidden">
        <div id="skill-config-panel">
            <button id="close-skill-config-button">X</button>
            <h3 id="skill-config-title">Configure Skill</h3>
            <input type="hidden" id="editing-skill-id">

            <div class="setting">
                <label for="skill-name-input">Skill Name:</label>
                <input type="text" id="skill-name-input" placeholder="e.g., French Reading">
            </div>

            <div class="setting">
                <label for="skill-verification-method">Verification Method:</label>
                <select id="skill-verification-method">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <div class="setting-grid">
                <div><label>Front Column(s):</label></div>
                <div><label>Back Column(s):</label></div>
                <div id="skill-front-columns" class="column-checkbox-group"></div>
                <div id="skill-back-columns" class="column-checkbox-group"></div>
            </div>

            <div class="setting">
                <label for="skill-validation-column">Validation Column:</label>
                <select id="skill-validation-column" disabled>
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <div class="setting">
                <label for="skill-tts-front-column">TTS (Front) Column:</label>
                <select id="skill-tts-front-column">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <div class="setting">
                <label for="skill-tts-back-column">TTS (Back) Column:</label>
                <select id="skill-tts-back-column">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <div class="setting">
                <input type="checkbox" id="skill-alternate-uppercase">
                <label for="skill-alternate-uppercase">Alternate Uppercase on Front</label>
            </div>
            <div class="setting">
                <input type="checkbox" id="skill-tts-on-hotkey-only">
                <label for="skill-tts-on-hotkey-only">Only read on hotkey (f)</label>
            </div>

            <div class="button-container">
                <button id="save-skill-button">Save Skill</button>
            </div>
        </div>
    </div>


    <div id="card-container">
      <div id="card-wrapper">
          <div id="card">
            <div class="card-face card-front">
                <div class="tts-lang-display" id="tts-lang-display-front"></div>
                <div id="card-front-content"></div>
            </div>
            <div class="card-face card-back">
                <div class="tts-lang-display" id="tts-lang-display-back"></div>
                <div id="card-back-content"></div>
                <div id="comparison-container" class="hidden"></div>
            </div>
          </div>
          <div class="card-overlays">
              <div id="deck-title"></div>
              <div id="last-seen"></div>
              <div id="skill-mastery-dashboard"></div>
              <div id="writing-practice-container" class="hidden">
                <button id="slow-replay-button">üîä</button>
                <input type="text" id="writing-input" placeholder="Type the answer..." autocomplete="off">
                <button id="writing-submit">Submit</button>
              </div>
              <div id="multiple-choice-container" class="hidden">
                <!-- buttons will be dynamically generated here -->
              </div>
              <div id="voice-input-container" class="hidden">
                <button id="voice-input-button" title="Start/Stop Voice Input">üé§</button>
                <div id="voice-input-feedback"></div>
              </div>
          </div>
      </div>
      <div id="explanation-message"></div>
    </div>

    <div id="controls">
      <button id="prev-card"><span>‚¨ÖÔ∏è</span><span class="btn-text"> Prev (&larr;)</span></button>
      <button id="i-dont-know"><span>‚ùå</span><span class="btn-text"> I don't know (j)</span></button>
      <button id="flip-card"><span>üîÑ</span><span class="btn-text"> Flip (Space)</span></button>
      <button id="i-know"><span>‚úÖ</span><span class="btn-text"> I know this (k)</span></button>
      <button id="next-card"><span>‚û°Ô∏è</span><span class="btn-text"> Next (&rarr;)</span></button>
      <button id="slow-replay-hotkey"><span>üîÅ</span><span class="btn-text"> Replay (f)</span></button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/diff/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script type="module" src="app.js"></script>
  </body>
</html>