<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alphabet Learning App</title>
    <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/DrawSVGPlugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-path-parser@1.1.0/dist/svg-path-parser.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        #app-container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #555;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.active {
            background-color: #0056b3;
        }

        #alphabet-buttons, #character-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .character-grid button {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
        }

        .hidden {
            display: none;
        }

        #character-display-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .animation-box {
            width: 200px;
            height: 200px;
            border: 1px solid #ddd;
        }

        .animation-box svg path {
            stroke: #333;
            stroke-width: 5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #drawing-canvas {
            border: 1px solid #333;
            cursor: crosshair;
        }

        .main-columns {
            display: flex;
            gap: 20px;
        }

        #left-column {
            flex: 1;
        }

        #right-column {
            flex: 2;
        }

        #hamburger-menu {
            cursor: pointer;
        }

        #hamburger-menu span {
            display: block;
            width: 25px;
            height: 3px;
            margin: 5px;
            background: #333;
        }

        #settings-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: left 0.3s;
            padding: 20px;
            z-index: 1000;
        }

        #settings-panel.open {
            left: 0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="file-protocol-error" style="display: none; padding: 20px; text-align: center; max-width: 600px; margin: 40px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
        <h2 style="color: #d9534f;">Unsupported Protocol</h2>
        <p style="font-size: 1.1em;">This application cannot be run directly from the local file system (<code style="background: #eee; padding: 2px 5px; border-radius: 3px;">file://</code>) due to browser security restrictions that block its database features.</p>
        <hr style="margin: 20px 0;">
        <p><strong>To fix this, please start a simple local web server.</strong></p>
        <p>If you have Python installed, you can run one of the following commands in your terminal from the project's root directory:</p>
        <pre style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; border: 1px solid #ddd; text-align: left;"><code># For Python 3
python3 -m http.server

# For Python 2
python -m SimpleHTTPServer</code></pre>
        <p>After starting the server, open this page in your browser at:</p>
        <p><a href="http://localhost:8000/alphabet.html">http://localhost:8000/alphabet.html</a></p>
    </div>

    <div id="app-container">
        <header>
            <div id="hamburger-menu">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <h1>Alphabet Learning App</h1>
            <div id="mode-selector">
                <button id="train-mode-btn" class="active">Train</button>
                <button id="test-mode-btn">Test</button>
            </div>
        </header>

        <div id="settings-panel">
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="logging-toggle">Enable Logging</label>
                <input type="checkbox" id="logging-toggle">
            </div>
            <div class="setting-item">
                <label for="gridlines-toggle">Show Gridlines</label>
                <input type="checkbox" id="gridlines-toggle">
            </div>
            <div class="setting-item">
                <label for="alphabet-select">Alphabet</label>
                <select id="alphabet-select"></select>
            </div>
            <div class="setting-item">
                <span>Speech Language:</span>
                <span id="speech-language-display">Default</span>
            </div>
        </div>

        <main id="main-content" class="main-columns">
            <div id="left-column">
                <section id="character-grid-container">
                    <h2 id="character-grid-title">Select an alphabet from settings to begin</h2>
                    <div id="character-grid"></div>
                </section>
            </div>

            <div id="right-column">
                <section id="character-display-container" class="hidden">
                    <div id="character-info">
                        <h2 id="character-name"></h2>
                        <p>Uppercase: <span id="char-uppercase"></span></p>
                        <p>Lowercase: <span id="char-lowercase"></span></p>
                    </div>
                    <div id="animation-container-upper" class="animation-box">
                        <svg id="handwriting-svg-upper" viewBox="0 0 100 100"></svg>
                    </div>
                    <div id="animation-container-lower" class="animation-box">
                        <svg id="handwriting-svg-lower" viewBox="0 0 100 100"></svg>
                    </div>
                    <button id="replay-animation-btn">Replay Animation</button>
                    <button id="edit-strokes-btn">Edit Strokes</button>
                </section>

                <section id="testing-mode-container" class="hidden">
                    <h2 id="test-prompt"></h2>
                    <canvas id="drawing-canvas" width="400" height="400"></canvas>
                    <div id="test-feedback"></div>
                    <button id="submit-drawing-btn">Submit</button>
                </section>

                <section id="stroke-editor-container" class="hidden">
                    <h3>SVG Stroke Editor</h3>
                    <div>
                        <label for="uppercase-path-input">Uppercase Path Data:</label>
                        <textarea id="uppercase-path-input" rows="4" cols="50"></textarea>
                    </div>
                    <div>
                        <label for="lowercase-path-input">Lowercase Path Data:</label>
                        <textarea id="lowercase-path-input" rows="4" cols="50"></textarea>
                    </div>
                    <button id="redraw-svg-btn">Redraw</button>
                    <button id="close-editor-btn">Close</button>
                </section>
            </div>
        </main>
    </div>

    <script>
        window.onload = function() {
            if (window.location.protocol === 'file:') {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('file-protocol-error').style.display = 'block';
                return; // Stop further execution
            }

            'use strict';

            // --- 0. CONSTANTS ---
            const MAX_INCORRECT_ATTEMPTS = 3;
            const FEEDBACK_TIMEOUT_MS = 1500;
            const HINT_TIMEOUT_MS = 4000;
            const CANVAS_WIDTH = 400;
            const CANVAS_HEIGHT = 400;
            const SVG_VIEWBOX_SIZE = 100;
            const STROKE_VALIDATION_THRESHOLD = 20;

            // --- 1. DATABASE SETUP ---
            const db = new Dexie('AlphabetDB');
            db.version(1).stores({
                alphabets: '++id, name, languageCode',
                characters: '++id, &characterId, alphabetId, name, order',
                userProgress: '++id, characterId, lastTested, correctCount, incorrectCount'
            });

            // --- 2. DATA DEFINITION ---
            // This is the pre-authored data for the application.
            const alphabetsData = [
                { id: 1, name: 'Greek', languageCode: 'el-GR' },
                { id: 2, name: 'Italian', languageCode: 'it-IT' },
                { id: 3, name: 'Spanish', languageCode: 'es-ES' },
                { id: 4, name: 'Turkish', languageCode: 'tr-TR' }
            ];

            const charactersData = [
                // --- Greek Characters (24) ---
                { characterId: 'greek-alpha', alphabetName: 'Greek', name: 'Alpha', order: 1, uppercase: 'Α', lowercase: 'α', pronunciationKey: 'Alpha', strokeSVGPaths: { uppercase: ["M50,10 L10,90", "M90,90 L50,10", "M30,60 L70,60"], lowercase: ["M70,40 C70,20 40,20 40,50 C40,80 70,80 70,60 L30,90"] } },
                { characterId: 'greek-beta', alphabetName: 'Greek', name: 'Beta', order: 2, uppercase: 'Β', lowercase: 'β', pronunciationKey: 'Beta', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M20,50 C80,50 80,90 20,90"], lowercase: ["M40,10 L40,90", "M40,50 C80,50 80,90 40,90"] } },
                { characterId: 'greek-gamma', alphabetName: 'Greek', name: 'Gamma', order: 3, uppercase: 'Γ', lowercase: 'γ', pronunciationKey: 'Gamma', strokeSVGPaths: { uppercase: ["M80,10 L20,10 L20,90"], lowercase: ["M20,20 L80,80", "M80,20 L20,80"] } },
                { characterId: 'greek-delta', alphabetName: 'Greek', name: 'Delta', order: 4, uppercase: 'Δ', lowercase: 'δ', pronunciationKey: 'Delta', strokeSVGPaths: { uppercase: ["M50,10 L10,90 L90,90 Z"], lowercase: ["M50,20 C20,20 20,80 50,80 C80,80 80,20 50,20 Z", "M50,20 L50,90"] } },
                { characterId: 'greek-epsilon', alphabetName: 'Greek', name: 'Epsilon', order: 5, uppercase: 'Ε', lowercase: 'ε', pronunciationKey: 'Epsilon', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50", "M80,90 L20,90"], lowercase: ["M80,50 C20,50 20,80 80,80"] } },
                { characterId: 'greek-zeta', alphabetName: 'Greek', name: 'Zeta', order: 6, uppercase: 'Ζ', lowercase: 'ζ', pronunciationKey: 'Zeta', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M20,90 L80,90", "M80,10 L20,90"], lowercase: ["M20,20 C80,20 80,50 20,50 C80,50 80,80 20,80 L20,90"] } },
                { characterId: 'greek-eta', alphabetName: 'Greek', name: 'Eta', order: 7, uppercase: 'Η', lowercase: 'η', pronunciationKey: 'Eta', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L80,90", "M20,50 L80,50"], lowercase: ["M20,20 L20,80", "M20,40 C80,40 80,80 20,80"] } },
                { characterId: 'greek-theta', alphabetName: 'Greek', name: 'Theta', order: 8, uppercase: 'Θ', lowercase: 'θ', pronunciationKey: 'Theta', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z", "M20,50 L80,50"], lowercase: ["M50,20 C20,20 20,80 50,80 C80,80 80,20 50,20 Z", "M30,50 L70,50"] } },
                { characterId: 'greek-iota', alphabetName: 'Greek', name: 'Iota', order: 9, uppercase: 'Ι', lowercase: 'ι', pronunciationKey: 'Iota', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90", "M20,90 L80,90"], lowercase: ["M50,20 L50,80"] } },
                { characterId: 'greek-kappa', alphabetName: 'Greek', name: 'Kappa', order: 10, uppercase: 'Κ', lowercase: 'κ', pronunciationKey: 'Kappa', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,50", "M20,50 L80,90"], lowercase: ["M20,20 L20,80", "M60,20 L20,50", "M20,50 L60,80"] } },
                { characterId: 'greek-lambda', alphabetName: 'Greek', name: 'Lambda', order: 11, uppercase: 'Λ', lowercase: 'λ', pronunciationKey: 'Lambda', strokeSVGPaths: { uppercase: ["M10,90 L50,10", "M50,10 L90,90"], lowercase: ["M30,20 L70,80", "M70,20 L30,80"] } },
                { characterId: 'greek-mu', alphabetName: 'Greek', name: 'Mu', order: 12, uppercase: 'Μ', lowercase: 'μ', pronunciationKey: 'Mu', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L50,50 L80,10 L80,90"], lowercase: ["M20,80 L20,20", "M20,40 C80,40 80,80 20,80"] } },
                { characterId: 'greek-nu', alphabetName: 'Greek', name: 'Nu', order: 13, uppercase: 'Ν', lowercase: 'ν', pronunciationKey: 'Nu', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L80,90 L80,10"], lowercase: ["M20,20 L80,80"] } },
                { characterId: 'greek-xi', alphabetName: 'Greek', name: 'Xi', order: 14, uppercase: 'Ξ', lowercase: 'ξ', pronunciationKey: 'Xi', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M20,50 L80,50", "M20,90 L80,90"], lowercase: ["M20,20 C80,20 80,50 20,50 C80,50 80,80 20,80"] } },
                { characterId: 'greek-omicron', alphabetName: 'Greek', name: 'Omicron', order: 15, uppercase: 'Ο', lowercase: 'ο', pronunciationKey: 'Omicron', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z"], lowercase: ["M50,30 C30,30 30,70 50,70 C70,70 70,30 50,30 Z"] } },
                { characterId: 'greek-pi', alphabetName: 'Greek', name: 'Pi', order: 16, uppercase: 'Π', lowercase: 'π', pronunciationKey: 'Pi', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M20,10 L20,90", "M80,10 L80,90"], lowercase: ["M20,20 L80,20", "M30,20 L30,80", "M70,20 L70,80"] } },
                { characterId: 'greek-rho', alphabetName: 'Greek', name: 'Rho', order: 17, uppercase: 'Ρ', lowercase: 'ρ', pronunciationKey: 'Rho', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50"], lowercase: ["M20,20 L20,80", "M20,20 C60,20 60,50 20,50"] } },
                { characterId: 'greek-sigma', alphabetName: 'Greek', name: 'Sigma', order: 18, uppercase: 'Σ', lowercase: 'σ', pronunciationKey: 'Sigma', strokeSVGPaths: { uppercase: ["M20,10 L80,10 L50,50 L80,90 L20,90"], lowercase: ["M70,30 C30,30 30,70 70,70"] } },
                { characterId: 'greek-tau', alphabetName: 'Greek', name: 'Tau', order: 19, uppercase: 'Τ', lowercase: 'τ', pronunciationKey: 'Tau', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90"], lowercase: ["M20,20 L80,20", "M50,20 L50,80 C50,80 20,80 20,50"] } },
                { characterId: 'greek-upsilon', alphabetName: 'Greek', name: 'Upsilon', order: 20, uppercase: 'Υ', lowercase: 'υ', pronunciationKey: 'Upsilon', strokeSVGPaths: { uppercase: ["M20,10 L50,50", "M80,10 L50,50", "M50,50 L50,90"], lowercase: ["M20,20 L40,80", "M80,20 L60,80"] } },
                { characterId: 'greek-phi', alphabetName: 'Greek', name: 'Phi', order: 21, uppercase: 'Φ', lowercase: 'φ', pronunciationKey: 'Phi', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z", "M50,10 L50,90"], lowercase: ["M50,20 C20,20 20,80 50,80 C80,80 80,20 50,20 Z", "M50,20 L50,90"] } },
                { characterId: 'greek-chi', alphabetName: 'Greek', name: 'Chi', order: 22, uppercase: 'Χ', lowercase: 'χ', pronunciationKey: 'Chi', strokeSVGPaths: { uppercase: ["M20,10 L80,90", "M80,10 L20,90"], lowercase: ["M20,20 L80,80", "M80,20 L20,80"] } },
                { characterId: 'greek-psi', alphabetName: 'Greek', name: 'Psi', order: 23, uppercase: 'Ψ', lowercase: 'ψ', pronunciationKey: 'Psi', strokeSVGPaths: { uppercase: ["M20,50 L50,10", "M80,50 L50,10", "M50,10 L50,90"], lowercase: ["M20,50 C50,20 80,50 80,50", "M50,20 L50,80"] } },
                { characterId: 'greek-omega', alphabetName: 'Greek', name: 'Omega', order: 24, uppercase: 'Ω', lowercase: 'ω', pronunciationKey: 'Omega', strokeSVGPaths: { uppercase: ["M20,80 C20,20 80,20 80,80", "M20,80 L20,90", "M80,80 L80,90"], lowercase: ["M20,50 C20,30 80,30 80,50 C80,70 20,70 20,50 Z"] } },

                // --- Italian Characters (21) ---
                { characterId: 'italian-a', alphabetName: 'Italian', name: 'A', order: 1, uppercase: 'A', lowercase: 'a', pronunciationKey: 'A', strokeSVGPaths: { uppercase: ["M50,10 L10,90", "M50,10 L90,90", "M30,60 L70,60"], lowercase: ["M70,40 C70,20 40,20 40,50 L40,80", "M40,50 C70,50 70,80 40,80"] } },
                { characterId: 'italian-b', alphabetName: 'Italian', name: 'B', order: 2, uppercase: 'B', lowercase: 'b', pronunciationKey: 'B', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M20,50 C80,50 80,90 20,90"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'italian-c', alphabetName: 'Italian', name: 'C', order: 3, uppercase: 'C', lowercase: 'c', pronunciationKey: 'C', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80"], lowercase: ["M70,30 C30,30 30,70 70,70"] } },
                { characterId: 'italian-d', alphabetName: 'Italian', name: 'D', order: 4, uppercase: 'D', lowercase: 'd', pronunciationKey: 'D', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C90,10 90,90 20,90"], lowercase: ["M80,10 L80,80", "M80,40 C40,40 40,80 80,80"] } },
                { characterId: 'italian-e', alphabetName: 'Italian', name: 'E', order: 5, uppercase: 'E', lowercase: 'e', pronunciationKey: 'E', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50", "M80,90 L20,90"], lowercase: ["M20,50 L80,50", "M80,50 C20,50 20,80 80,80"] } },
                { characterId: 'italian-f', alphabetName: 'Italian', name: 'F', order: 6, uppercase: 'F', lowercase: 'f', pronunciationKey: 'F', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50"], lowercase: ["M60,10 C40,10 40,80 60,80", "M40,40 L80,40"] } },
                { characterId: 'italian-g', alphabetName: 'Italian', name: 'G', order: 7, uppercase: 'G', lowercase: 'g', pronunciationKey: 'G', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80 L80,50 L50,50"], lowercase: ["M70,30 C30,30 30,70 70,70 L70,90 C30,90 30,70 70,70"] } },
                { characterId: 'italian-h', alphabetName: 'Italian', name: 'H', order: 8, uppercase: 'H', lowercase: 'h', pronunciationKey: 'H', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L80,90", "M20,50 L80,50"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'italian-i', alphabetName: 'Italian', name: 'I', order: 9, uppercase: 'I', lowercase: 'i', pronunciationKey: 'I', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90", "M20,90 L80,90"], lowercase: ["M50,40 L50,80", "M50,20 L50,30"] } },
                { characterId: 'italian-l', alphabetName: 'Italian', name: 'L', order: 10, uppercase: 'L', lowercase: 'l', pronunciationKey: 'L', strokeSVGPaths: { uppercase: ["M20,10 L20,90 L80,90"], lowercase: ["M50,10 L50,80"] } },
                { characterId: 'italian-m', alphabetName: 'Italian', name: 'M', order: 11, uppercase: 'M', lowercase: 'm', pronunciationKey: 'M', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L50,50 L80,10 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C40,40 40,80 20,80", "M50,40 C70,40 70,80 50,80"] } },
                { characterId: 'italian-n', alphabetName: 'Italian', name: 'N', order: 12, uppercase: 'N', lowercase: 'n', pronunciationKey: 'N', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L80,90 L80,10"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'italian-o', alphabetName: 'Italian', name: 'O', order: 13, uppercase: 'O', lowercase: 'o', pronunciationKey: 'O', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z"], lowercase: ["M50,40 C30,40 30,80 50,80 C70,80 70,40 50,40 Z"] } },
                { characterId: 'italian-p', alphabetName: 'Italian', name: 'P', order: 14, uppercase: 'P', lowercase: 'p', pronunciationKey: 'P', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50"], lowercase: ["M20,20 L20,90", "M20,20 C60,20 60,50 20,50"] } },
                { characterId: 'italian-q', alphabetName: 'Italian', name: 'Q', order: 15, uppercase: 'Q', lowercase: 'q', pronunciationKey: 'Q', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z", "M70,70 L90,90"], lowercase: ["M80,20 L80,90", "M80,20 C40,20 40,50 80,50"] } },
                { characterId: 'italian-r', alphabetName: 'Italian', name: 'R', order: 16, uppercase: 'R', lowercase: 'r', pronunciationKey: 'R', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M50,50 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,60 20,60"] } },
                { characterId: 'italian-s', alphabetName: 'Italian', name: 'S', order: 17, uppercase: 'S', lowercase: 's', pronunciationKey: 'S', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,50 50,50 C80,50 80,80 20,80"], lowercase: ["M70,30 C30,30 30,50 50,50 C70,50 70,70 30,70"] } },
                { characterId: 'italian-t', alphabetName: 'Italian', name: 'T', order: 18, uppercase: 'T', lowercase: 't', pronunciationKey: 'T', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90"], lowercase: ["M50,20 L50,80", "M30,80 L70,80", "M50,20 C20,20 20,50 50,50"] } },
                { characterId: 'italian-u', alphabetName: 'Italian', name: 'U', order: 19, uppercase: 'U', lowercase: 'u', pronunciationKey: 'U', strokeSVGPaths: { uppercase: ["M20,10 L20,70 C20,90 80,90 80,70 L80,10"], lowercase: ["M20,40 L20,70 C20,80 60,80 60,70 L60,40"] } },
                { characterId: 'italian-v', alphabetName: 'Italian', name: 'V', order: 20, uppercase: 'V', lowercase: 'v', pronunciationKey: 'V', strokeSVGPaths: { uppercase: ["M10,10 L50,90 L90,10"], lowercase: ["M20,40 L50,80 L80,40"] } },
                { characterId: 'italian-z', alphabetName: 'Italian', name: 'Z', order: 21, uppercase: 'Z', lowercase: 'z', pronunciationKey: 'Z', strokeSVGPaths: { uppercase: ["M20,10 L80,10 L20,90 L80,90"], lowercase: ["M20,40 L80,40 L20,80 L80,80"] } },

                // --- Spanish Characters (27) ---
                { characterId: 'spanish-a', alphabetName: 'Spanish', name: 'A', order: 1, uppercase: 'A', lowercase: 'a', pronunciationKey: 'A', strokeSVGPaths: { uppercase: ["M50,10 L10,90", "M50,10 L90,90", "M30,60 L70,60"], lowercase: ["M70,40 C70,20 40,20 40,50 L40,80", "M40,50 C70,50 70,80 40,80"] } },
                { characterId: 'spanish-b', alphabetName: 'Spanish', name: 'B', order: 2, uppercase: 'B', lowercase: 'b', pronunciationKey: 'B', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M20,50 C80,50 80,90 20,90"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'spanish-c', alphabetName: 'Spanish', name: 'C', order: 3, uppercase: 'C', lowercase: 'c', pronunciationKey: 'C', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80"], lowercase: ["M70,30 C30,30 30,70 70,70"] } },
                { characterId: 'spanish-d', alphabetName: 'Spanish', name: 'D', order: 4, uppercase: 'D', lowercase: 'd', pronunciationKey: 'D', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C90,10 90,90 20,90"], lowercase: ["M80,10 L80,80", "M80,40 C40,40 40,80 80,80"] } },
                { characterId: 'spanish-e', alphabetName: 'Spanish', name: 'E', order: 5, uppercase: 'E', lowercase: 'e', pronunciationKey: 'E', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50", "M80,90 L20,90"], lowercase: ["M20,50 L80,50", "M80,50 C20,50 20,80 80,80"] } },
                { characterId: 'spanish-f', alphabetName: 'Spanish', name: 'F', order: 6, uppercase: 'F', lowercase: 'f', pronunciationKey: 'F', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50"], lowercase: ["M60,10 C40,10 40,80 60,80", "M40,40 L80,40"] } },
                { characterId: 'spanish-g', alphabetName: 'Spanish', name: 'G', order: 7, uppercase: 'G', lowercase: 'g', pronunciationKey: 'G', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80 L80,50 L50,50"], lowercase: ["M70,30 C30,30 30,70 70,70 L70,90 C30,90 30,70 70,70"] } },
                { characterId: 'spanish-h', alphabetName: 'Spanish', name: 'H', order: 8, uppercase: 'H', lowercase: 'h', pronunciationKey: 'H', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L80,90", "M20,50 L80,50"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'spanish-i', alphabetName: 'Spanish', name: 'I', order: 9, uppercase: 'I', lowercase: 'i', pronunciationKey: 'I', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90", "M20,90 L80,90"], lowercase: ["M50,40 L50,80", "M50,20 L50,30"] } },
                { characterId: 'spanish-j', alphabetName: 'Spanish', name: 'J', order: 10, uppercase: 'J', lowercase: 'j', pronunciationKey: 'Jota', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90 C50,90 20,90 20,60"], lowercase: ["M50,40 L50,90 C50,90 20,90 20,60", "M50,20 L50,30"] } },
                { characterId: 'spanish-k', alphabetName: 'Spanish', name: 'K', order: 11, uppercase: 'K', lowercase: 'k', pronunciationKey: 'K', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,50", "M20,50 L80,90"], lowercase: ["M20,20 L20,80", "M60,20 L20,50", "M20,50 L60,80"] } },
                { characterId: 'spanish-l', alphabetName: 'Spanish', name: 'L', order: 12, uppercase: 'L', lowercase: 'l', pronunciationKey: 'L', strokeSVGPaths: { uppercase: ["M20,10 L20,90 L80,90"], lowercase: ["M50,10 L50,80"] } },
                { characterId: 'spanish-m', alphabetName: 'Spanish', name: 'M', order: 13, uppercase: 'M', lowercase: 'm', pronunciationKey: 'M', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L50,50 L80,10 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C40,40 40,80 20,80", "M50,40 C70,40 70,80 50,80"] } },
                { characterId: 'spanish-n', alphabetName: 'Spanish', name: 'N', order: 14, uppercase: 'N', lowercase: 'n', pronunciationKey: 'N', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L80,90 L80,10"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'spanish-ntilde', alphabetName: 'Spanish', name: 'Ñ', order: 15, uppercase: 'Ñ', lowercase: 'ñ', pronunciationKey: 'Eñe', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L80,90 L80,10", "M20,5 C80,5 80,15 20,15"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,80 20,80", "M20,35 C80,35 80,45 20,45"] } },
                { characterId: 'spanish-o', alphabetName: 'Spanish', name: 'O', order: 16, uppercase: 'O', lowercase: 'o', pronunciationKey: 'O', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z"], lowercase: ["M50,40 C30,40 30,80 50,80 C70,80 70,40 50,40 Z"] } },
                { characterId: 'spanish-p', alphabetName: 'Spanish', name: 'P', order: 17, uppercase: 'P', lowercase: 'p', pronunciationKey: 'P', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50"], lowercase: ["M20,20 L20,90", "M20,20 C60,20 60,50 20,50"] } },
                { characterId: 'spanish-q', alphabetName: 'Spanish', name: 'Q', order: 18, uppercase: 'Q', lowercase: 'q', pronunciationKey: 'Q', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z", "M70,70 L90,90"], lowercase: ["M80,20 L80,90", "M80,20 C40,20 40,50 80,50"] } },
                { characterId: 'spanish-r', alphabetName: 'Spanish', name: 'R', order: 19, uppercase: 'R', lowercase: 'r', pronunciationKey: 'R', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M50,50 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,60 20,60"] } },
                { characterId: 'spanish-s', alphabetName: 'Spanish', name: 'S', order: 20, uppercase: 'S', lowercase: 's', pronunciationKey: 'S', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,50 50,50 C80,50 80,80 20,80"], lowercase: ["M70,30 C30,30 30,50 50,50 C70,50 70,70 30,70"] } },
                { characterId: 'spanish-t', alphabetName: 'Spanish', name: 'T', order: 21, uppercase: 'T', lowercase: 't', pronunciationKey: 'T', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90"], lowercase: ["M50,20 L50,80", "M30,80 L70,80", "M50,20 C20,20 20,50 50,50"] } },
                { characterId: 'spanish-u', alphabetName: 'Spanish', name: 'U', order: 22, uppercase: 'U', lowercase: 'u', pronunciationKey: 'U', strokeSVGPaths: { uppercase: ["M20,10 L20,70 C20,90 80,90 80,70 L80,10"], lowercase: ["M20,40 L20,70 C20,80 60,80 60,70 L60,40"] } },
                { characterId: 'spanish-v', alphabetName: 'Spanish', name: 'V', order: 23, uppercase: 'V', lowercase: 'v', pronunciationKey: 'V', strokeSVGPaths: { uppercase: ["M10,10 L50,90 L90,10"], lowercase: ["M20,40 L50,80 L80,40"] } },
                { characterId: 'spanish-w', alphabetName: 'Spanish', name: 'W', order: 24, uppercase: 'W', lowercase: 'w', pronunciationKey: 'Doble U', strokeSVGPaths: { uppercase: ["M10,10 L30,90 L50,10 L70,90 L90,10"], lowercase: ["M20,40 L40,80 L50,40 L60,80 L80,40"] } },
                { characterId: 'spanish-x', alphabetName: 'Spanish', name: 'X', order: 25, uppercase: 'X', lowercase: 'x', pronunciationKey: 'Equis', strokeSVGPaths: { uppercase: ["M20,10 L80,90", "M80,10 L20,90"], lowercase: ["M20,40 L80,80", "M80,40 L20,80"] } },
                { characterId: 'spanish-y', alphabetName: 'Spanish', name: 'Y', order: 26, uppercase: 'Y', lowercase: 'y', pronunciationKey: 'I Griega', strokeSVGPaths: { uppercase: ["M20,10 L50,50", "M80,10 L50,50", "M50,50 L50,90"], lowercase: ["M20,40 L50,80", "M80,40 L20,80"] } },
                { characterId: 'spanish-z', alphabetName: 'Spanish', name: 'Z', order: 27, uppercase: 'Z', lowercase: 'z', pronunciationKey: 'Zeta', strokeSVGPaths: { uppercase: ["M20,10 L80,10 L20,90 L80,90"], lowercase: ["M20,40 L80,40 L20,80 L80,80"] } },

                // --- Turkish Characters (29) ---
                { characterId: 'turkish-a', alphabetName: 'Turkish', name: 'A', order: 1, uppercase: 'A', lowercase: 'a', pronunciationKey: 'A', strokeSVGPaths: { uppercase: ["M50,10 L10,90", "M50,10 L90,90", "M30,60 L70,60"], lowercase: ["M70,40 C70,20 40,20 40,50 L40,80", "M40,50 C70,50 70,80 40,80"] } },
                { characterId: 'turkish-b', alphabetName: 'Turkish', name: 'B', order: 2, uppercase: 'B', lowercase: 'b', pronunciationKey: 'B', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M20,50 C80,50 80,90 20,90"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'turkish-c', alphabetName: 'Turkish', name: 'C', order: 3, uppercase: 'C', lowercase: 'c', pronunciationKey: 'C', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80"], lowercase: ["M70,30 C30,30 30,70 70,70"] } },
                { characterId: 'turkish-c-cedilla', alphabetName: 'Turkish', name: 'Ç', order: 4, uppercase: 'Ç', lowercase: 'ç', pronunciationKey: 'Çe', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80", "M50,90 C40,95 60,95 50,90"], lowercase: ["M70,30 C30,30 30,70 70,70", "M50,80 C40,85 60,85 50,80"] } },
                { characterId: 'turkish-d', alphabetName: 'Turkish', name: 'D', order: 5, uppercase: 'D', lowercase: 'd', pronunciationKey: 'D', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C90,10 90,90 20,90"], lowercase: ["M80,10 L80,80", "M80,40 C40,40 40,80 80,80"] } },
                { characterId: 'turkish-e', alphabetName: 'Turkish', name: 'E', order: 6, uppercase: 'E', lowercase: 'e', pronunciationKey: 'E', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50", "M80,90 L20,90"], lowercase: ["M20,50 L80,50", "M80,50 C20,50 20,80 80,80"] } },
                { characterId: 'turkish-f', alphabetName: 'Turkish', name: 'F', order: 7, uppercase: 'F', lowercase: 'f', pronunciationKey: 'F', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,10", "M80,50 L20,50"], lowercase: ["M60,10 C40,10 40,80 60,80", "M40,40 L80,40"] } },
                { characterId: 'turkish-g', alphabetName: 'Turkish', name: 'G', order: 8, uppercase: 'G', lowercase: 'g', pronunciationKey: 'G', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80 L80,50 L50,50"], lowercase: ["M70,30 C30,30 30,70 70,70 L70,90 C30,90 30,70 70,70"] } },
                { characterId: 'turkish-g-breve', alphabetName: 'Turkish', name: 'Ğ', order: 9, uppercase: 'Ğ', lowercase: 'ğ', pronunciationKey: 'Yumuşak G', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,80 80,80 L80,50 L50,50", "M40,5 C60,5 60,15 40,15"], lowercase: ["M70,30 C30,30 30,70 70,70 L70,90 C30,90 30,70 70,70", "M40,20 C60,20 60,30 40,30"] } },
                { characterId: 'turkish-h', alphabetName: 'Turkish', name: 'H', order: 10, uppercase: 'H', lowercase: 'h', pronunciationKey: 'H', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L80,90", "M20,50 L80,50"], lowercase: ["M20,10 L20,80", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'turkish-i-dotless', alphabetName: 'Turkish', name: 'I', order: 11, uppercase: 'I', lowercase: 'ı', pronunciationKey: 'I', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90", "M20,90 L80,90"], lowercase: ["M50,40 L50,80"] } },
                { characterId: 'turkish-i-dotted', alphabetName: 'Turkish', name: 'İ', order: 12, uppercase: 'İ', lowercase: 'i', pronunciationKey: 'İ', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90", "M20,90 L80,90", "M50,-5 L50,5"], lowercase: ["M50,40 L50,80", "M50,20 L50,30"] } },
                { characterId: 'turkish-j', alphabetName: 'Turkish', name: 'J', order: 13, uppercase: 'J', lowercase: 'j', pronunciationKey: 'J', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90 C50,90 20,90 20,60"], lowercase: ["M50,40 L50,90 C50,90 20,90 20,60", "M50,20 L50,30"] } },
                { characterId: 'turkish-k', alphabetName: 'Turkish', name: 'K', order: 14, uppercase: 'K', lowercase: 'k', pronunciationKey: 'K', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M80,10 L20,50", "M20,50 L80,90"], lowercase: ["M20,20 L20,80", "M60,20 L20,50", "M20,50 L60,80"] } },
                { characterId: 'turkish-l', alphabetName: 'Turkish', name: 'L', order: 15, uppercase: 'L', lowercase: 'l', pronunciationKey: 'L', strokeSVGPaths: { uppercase: ["M20,10 L20,90 L80,90"], lowercase: ["M50,10 L50,80"] } },
                { characterId: 'turkish-m', alphabetName: 'Turkish', name: 'M', order: 16, uppercase: 'M', lowercase: 'm', pronunciationKey: 'M', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L50,50 L80,10 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C40,40 40,80 20,80", "M50,40 C70,40 70,80 50,80"] } },
                { characterId: 'turkish-n', alphabetName: 'Turkish', name: 'N', order: 17, uppercase: 'N', lowercase: 'n', pronunciationKey: 'N', strokeSVGPaths: { uppercase: ["M20,90 L20,10 L80,90 L80,10"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,80 20,80"] } },
                { characterId: 'turkish-o', alphabetName: 'Turkish', name: 'O', order: 18, uppercase: 'O', lowercase: 'o', pronunciationKey: 'O', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z"], lowercase: ["M50,40 C30,40 30,80 50,80 C70,80 70,40 50,40 Z"] } },
                { characterId: 'turkish-o-diaeresis', alphabetName: 'Turkish', name: 'Ö', order: 19, uppercase: 'Ö', lowercase: 'ö', pronunciationKey: 'Ö', strokeSVGPaths: { uppercase: ["M50,10 C10,10 10,90 50,90 C90,90 90,10 50,10 Z", "M30,-5 L30,5", "M70,-5 L70,5"], lowercase: ["M50,40 C30,40 30,80 50,80 C70,80 70,40 50,40 Z", "M30,25 L30,35", "M70,25 L70,35"] } },
                { characterId: 'turkish-p', alphabetName: 'Turkish', name: 'P', order: 20, uppercase: 'P', lowercase: 'p', pronunciationKey: 'P', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50"], lowercase: ["M20,20 L20,90", "M20,20 C60,20 60,50 20,50"] } },
                { characterId: 'turkish-r', alphabetName: 'Turkish', name: 'R', order: 21, uppercase: 'R', lowercase: 'r', pronunciationKey: 'R', strokeSVGPaths: { uppercase: ["M20,10 L20,90", "M20,10 C80,10 80,50 20,50", "M50,50 L80,90"], lowercase: ["M20,80 L20,40", "M20,40 C60,40 60,60 20,60"] } },
                { characterId: 'turkish-s', alphabetName: 'Turkish', name: 'S', order: 22, uppercase: 'S', lowercase: 's', pronunciationKey: 'S', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,50 50,50 C80,50 80,80 20,80"], lowercase: ["M70,30 C30,30 30,50 50,50 C70,50 70,70 30,70"] } },
                { characterId: 'turkish-s-cedilla', alphabetName: 'Turkish', name: 'Ş', order: 23, uppercase: 'Ş', lowercase: 'ş', pronunciationKey: 'Şe', strokeSVGPaths: { uppercase: ["M80,20 C20,20 20,50 50,50 C80,50 80,80 20,80", "M50,90 C40,95 60,95 50,90"], lowercase: ["M70,30 C30,30 30,50 50,50 C70,50 70,70 30,70", "M50,80 C40,85 60,85 50,80"] } },
                { characterId: 'turkish-t', alphabetName: 'Turkish', name: 'T', order: 24, uppercase: 'T', lowercase: 't', pronunciationKey: 'T', strokeSVGPaths: { uppercase: ["M20,10 L80,10", "M50,10 L50,90"], lowercase: ["M50,20 L50,80", "M30,80 L70,80", "M50,20 C20,20 20,50 50,50"] } },
                { characterId: 'turkish-u', alphabetName: 'Turkish', name: 'U', order: 25, uppercase: 'U', lowercase: 'u', pronunciationKey: 'U', strokeSVGPaths: { uppercase: ["M20,10 L20,70 C20,90 80,90 80,70 L80,10"], lowercase: ["M20,40 L20,70 C20,80 60,80 60,70 L60,40"] } },
                { characterId: 'turkish-u-diaeresis', alphabetName: 'Turkish', name: 'Ü', order: 26, uppercase: 'Ü', lowercase: 'ü', pronunciationKey: 'Ü', strokeSVGPaths: { uppercase: ["M20,10 L20,70 C20,90 80,90 80,70 L80,10", "M30,-5 L30,5", "M70,-5 L70,5"], lowercase: ["M20,40 L20,70 C20,80 60,80 60,70 L60,40", "M30,25 L30,35", "M70,25 L70,35"] } },
                { characterId: 'turkish-v', alphabetName: 'Turkish', name: 'V', order: 27, uppercase: 'V', lowercase: 'v', pronunciationKey: 'V', strokeSVGPaths: { uppercase: ["M10,10 L50,90 L90,10"], lowercase: ["M20,40 L50,80 L80,40"] } },
                { characterId: 'turkish-y', alphabetName: 'Turkish', name: 'Y', order: 28, uppercase: 'Y', lowercase: 'y', pronunciationKey: 'Y', strokeSVGPaths: { uppercase: ["M20,10 L50,50", "M80,10 L50,50", "M50,50 L50,90"], lowercase: ["M20,40 L50,80", "M80,40 L20,80"] } },
                { characterId: 'turkish-z', alphabetName: 'Turkish', name: 'Z', order: 29, uppercase: 'Z', lowercase: 'z', pronunciationKey: 'Z', strokeSVGPaths: { uppercase: ["M20,10 L80,10 L20,90 L80,90"], lowercase: ["M20,40 L80,40 L20,80 L80,80"] } }
            ];

            // --- 3. DATA SEEDING LOGIC ---
            async function seedDatabase() {
                const alphabetCount = await db.alphabets.count();
                if (alphabetCount > 0) {
                    logger.log("Database already seeded.");
                    return; // Don't re-seed
                }

                logger.log("Seeding database...");
                try {
                    await db.transaction('rw', db.alphabets, db.characters, async () => {
                        const alphabetIds = await db.alphabets.bulkAdd(alphabetsData, { allKeys: true });
                        const nameToIdMap = {};
                        alphabetsData.forEach((alphabet, index) => {
                            nameToIdMap[alphabet.name] = alphabetIds[index];
                        });

                        const charactersToSeed = charactersData.map(char => ({
                            ...char,
                            alphabetId: nameToIdMap[char.alphabetName],
                            alphabetName: undefined
                        }));

                        await db.characters.bulkAdd(charactersToSeed);
                    });
                    logger.log("Database seeded successfully.");
                } catch (error) {
                    logger.error('Error seeding database:', error);
                    // Inform the user that a feature might not work
                    alert("There was an error initializing the alphabet data. Some features may not work correctly.");
                }
            }

            // --- 4. INITIALIZATION ---
            // Moved initialization logic to be called directly from window.onload
            // This avoids issues with nested DOMContentLoaded listeners.

            // --- 5. DOM ELEMENT REFERENCES ---
            const alphabetSelectionContainer = document.getElementById('alphabet-selection-container');
            const alphabetButtonsContainer = document.getElementById('alphabet-buttons');
            const characterGridContainer = document.getElementById('character-grid-container');
            const characterGridTitle = document.getElementById('character-grid-title');
            const characterGrid = document.getElementById('character-grid');
            const characterDisplayContainer = document.getElementById('character-display-container');
            const characterName = document.getElementById('character-name');
            const charUppercase = document.getElementById('char-uppercase');
            const charLowercase = document.getElementById('char-lowercase');
            const handwritingSvgUpper = document.getElementById('handwriting-svg-upper');
            const handwritingSvgLower = document.getElementById('handwriting-svg-lower');
            const replayAnimationBtn = document.getElementById('replay-animation-btn');

            const hamburgerMenu = document.getElementById('hamburger-menu');
            const settingsPanel = document.getElementById('settings-panel');
            const gridlinesToggle = document.getElementById('gridlines-toggle');
            const alphabetSelect = document.getElementById('alphabet-select');
            const speechLanguageDisplay = document.getElementById('speech-language-display');

            const editStrokesBtn = document.getElementById('edit-strokes-btn');
            const strokeEditorContainer = document.getElementById('stroke-editor-container');
            const uppercasePathInput = document.getElementById('uppercase-path-input');
            const lowercasePathInput = document.getElementById('lowercase-path-input');
            const redrawSvgBtn = document.getElementById('redraw-svg-btn');
            const closeEditorBtn = document.getElementById('close-editor-btn');

            const trainModeBtn = document.getElementById('train-mode-btn');
            const testModeBtn = document.getElementById('test-mode-btn');
            const testingModeContainer = document.getElementById('testing-mode-container');
            const testPrompt = document.getElementById('test-prompt');
            const drawingCanvas = document.getElementById('drawing-canvas');
            const testFeedback = document.getElementById('test-feedback');
            const submitDrawingBtn = document.getElementById('submit-drawing-btn');


            // --- 6. STATE MANAGEMENT & LOGGING ---
            const loggingToggle = document.getElementById('logging-toggle');
            let isLoggingEnabled = localStorage.getItem('alphabet-loggingEnabled') === 'true';

            const logger = {
                log: (...args) => isLoggingEnabled && console.log(...args),
                warn: (...args) => isLoggingEnabled && console.warn(...args),
                error: (...args) => isLoggingEnabled && console.error(...args),
            };

            function updateLoggingState(enabled) {
                isLoggingEnabled = enabled;
                localStorage.setItem('alphabet-loggingEnabled', enabled);
                logger.log(`Logging ${enabled ? 'enabled' : 'disabled'}.`);
            }

            // Define the complete shape of the appState object at initialization
            let appState = {
                currentAlphabetId: null,
                currentMode: 'train', // 'train' or 'test'
                currentCharForTest: null,
                caseForTest: null, // 'uppercase' or 'lowercase'
                incorrectAttempts: 0,
            };

            // --- 7. UI RENDERING & LOGIC ---
            async function initializeApp() {
                try {
                    gsap.registerPlugin(DrawSVGPlugin);

                    // Settings Panel Logic
                    hamburgerMenu.addEventListener('click', () => {
                        settingsPanel.classList.toggle('open');
                    });

                    document.getElementById('main-content').addEventListener('click', () => {
                        if (settingsPanel.classList.contains('open')) {
                            settingsPanel.classList.remove('open');
                        }
                    });

                    gridlinesToggle.addEventListener('change', (e) => {
                        drawingCanvas.style.backgroundImage = e.target.checked
                            ? 'linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px)'
                            : 'none';
                        drawingCanvas.style.backgroundSize = e.target.checked ? '20px 20px' : 'auto';
                    });

                    loggingToggle.checked = isLoggingEnabled;
                    loggingToggle.addEventListener('change', (e) => updateLoggingState(e.target.checked));
                    logger.log("Application initializing...");

                    await seedDatabase();
                    await populateAlphabetDropdown();

                    trainModeBtn.addEventListener('click', () => setMode('train'));
                    testModeBtn.addEventListener('click', () => setMode('test'));

                    // Set canvas dimensions from constants
                    drawingCanvas.width = CANVAS_WIDTH;
                    drawingCanvas.height = CANVAS_HEIGHT;
                } catch (err) {
                    console.error("Failed to initialize the application:", err);
                    alert("A critical error occurred during startup. Please refresh the page.");
                }
            }

            async function populateAlphabetDropdown() {
                try {
                    const alphabets = await db.alphabets.toArray();
                    alphabetSelect.innerHTML = '<option value="">Select Alphabet</option>';
                    alphabets.forEach(alphabet => {
                        const option = document.createElement('option');
                        option.value = alphabet.id;
                        option.textContent = alphabet.name;
                        alphabetSelect.appendChild(option);
                    });

                    alphabetSelect.addEventListener('change', async (e) => {
                        const alphabetId = parseInt(e.target.value, 10);
                        if (alphabetId) {
                            const alphabet = await db.alphabets.get(alphabetId);
                            selectAlphabet(alphabet);
                        }
                    });
                } catch (error) {
                    logger.error("Failed to populate alphabet dropdown:", error);
                }
            }

            async function selectAlphabet(alphabet) {
                try {
                    appState.currentAlphabetId = alphabet.id;
                    logger.log(`Selected alphabet: ${alphabet.name} (ID: ${alphabet.id})`);

                    const characters = await db.characters
                        .where('alphabetId')
                        .equals(alphabet.id)
                        .sortBy('order');

                    renderCharacterGrid(characters, alphabet.name);
                } catch (error) {
                    logger.error(`Failed to select alphabet ${alphabet.name}:`, error);
                }
            }

            function renderCharacterGrid(characters, alphabetName) {
                characterGridTitle.textContent = `${alphabetName} Characters`;
                characterGrid.innerHTML = ''; // Clear existing grid

                characters.forEach(char => {
                    const button = document.createElement('button');
                    button.innerHTML = `${char.uppercase}<br>${char.lowercase}`;
                    button.classList.add('character-grid-button');
                    button.addEventListener('click', () => displayCharacter(char.characterId));
                    characterGrid.appendChild(button);
                });

                // Switch views
                alphabetSelectionContainer.classList.add('hidden');
                characterGridContainer.classList.remove('hidden');
                characterDisplayContainer.classList.add('hidden');
            }

            async function displayCharacter(characterId) {
                try {
                    const character = await db.characters.get({ characterId });
                    if (!character) {
                        logger.warn(`Character with ID ${characterId} not found.`);
                        return;
                    };

                    const alphabet = await db.alphabets.get(character.alphabetId);
                    if (!alphabet) {
                        logger.warn(`Alphabet with ID ${character.alphabetId} not found.`);
                        return;
                    }

                    // Update UI
                    characterName.textContent = character.name;
                    charUppercase.textContent = character.uppercase;
                    charLowercase.textContent = character.lowercase;

                    const performActions = () => {
                        animateCharacter(handwritingSvgUpper, handwritingSvgLower, character.strokeSVGPaths);
                        speak(character.pronunciationKey, alphabet.languageCode);
                    };

                    performActions();
                    // Use addEventListener instead of onclick
                    replayAnimationBtn.removeEventListener('click', replayAnimationBtn.handler);
                    replayAnimationBtn.handler = performActions;
                    replayAnimationBtn.addEventListener('click', replayAnimationBtn.handler);

                    editStrokesBtn.removeEventListener('click', editStrokesBtn.handler);
                    editStrokesBtn.handler = () => openStrokeEditor(character);
                    editStrokesBtn.addEventListener('click', editStrokesBtn.handler);

                    // Switch views - keep character grid visible
                    characterDisplayContainer.classList.remove('hidden');
                } catch (error) {
                    logger.error(`Failed to display character ${characterId}:`, error);
                }
            }

            function animateCharacter(upperSvgElement, lowerSvgElement, strokePaths) {
                upperSvgElement.innerHTML = ''; // Clear previous animations
                lowerSvgElement.innerHTML = '';

                const tl = gsap.timeline();

                // Animate uppercase strokes
                strokePaths.uppercase.forEach(pathData => {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    upperSvgElement.appendChild(path);
                    tl.from(path, { drawSVG: 0, duration: 1 }, "+=0.1");
                });

                // Animate lowercase strokes
                strokePaths.lowercase.forEach(pathData => {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    lowerSvgElement.appendChild(path);
                    tl.from(path, { drawSVG: 0, duration: 1 }, "+=0.1");
                });
            }

            let voices = [];
            function loadAndCacheVoices() {
                voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    logger.log(`Speech synthesis voices loaded (${voices.length} voices).`);
                }
            }

            loadAndCacheVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadAndCacheVoices;
            }

            function speak(text, langCode) {
                if (!('speechSynthesis' in window)) {
                    logger.warn('Speech Synthesis not supported.');
                    speechLanguageDisplay.textContent = 'Not Supported';
                    return;
                }

                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langCode;

                // Improved voice finding logic
                const primaryLang = langCode.split('-')[0];
                let voice = voices.find(v => v.lang === langCode);
                if (!voice) {
                    voice = voices.find(v => v.lang.startsWith(primaryLang));
                }

                if (voice) {
                    utterance.voice = voice;
                    speechLanguageDisplay.textContent = voice.lang;
                    logger.log(`Using voice: ${voice.name} (${voice.lang})`);
                } else {
                    speechLanguageDisplay.textContent = `Default (${langCode})`;
                    logger.warn(`No specific voice found for lang '${langCode}' or '${primaryLang}'. Using browser default.`);
                }

                speechSynthesis.speak(utterance);
            }

            function setMode(mode) {
                appState.currentMode = mode;

                trainModeBtn.classList.toggle('active', mode === 'train');
                testModeBtn.classList.toggle('active', mode === 'test');

                if (mode === 'test') {
                    characterGridContainer.classList.add('hidden');
                    characterDisplayContainer.classList.add('hidden');
                    testingModeContainer.classList.remove('hidden');
                    startTest();
                } else {
                    testingModeContainer.classList.add('hidden');
                    // Show the character grid if an alphabet is selected
                    if (appState.currentAlphabetId) {
                        characterGridContainer.classList.remove('hidden');
                    } else {
                        characterGridContainer.classList.remove('hidden');
                    }
                }
            }

            async function startTest() {
                try {
                    if (!appState.currentAlphabetId) {
                        testPrompt.textContent = 'Please select an alphabet first.';
                        return;
                    }

                    // Intelligent character selection
                    const allCharacters = await db.characters.where('alphabetId').equals(appState.currentAlphabetId).toArray();
                    const characterIds = allCharacters.map(c => c.characterId);
                    const progressData = await db.userProgress.where('characterId').anyOf(characterIds).toArray();
                    const progressMap = new Map(progressData.map(p => [p.characterId, p]));

                    let characterToTest;
                    const untestedChars = allCharacters.filter(c => !progressMap.has(c.characterId));

                    if (untestedChars.length > 0) {
                        characterToTest = untestedChars[Math.floor(Math.random() * untestedChars.length)];
                    } else {
                        allCharacters.sort((a, b) => {
                            const progressA = progressMap.get(a.characterId);
                            const progressB = progressMap.get(b.characterId);
                            const scoreA = (progressA.correctCount || 0) / ((progressA.correctCount || 0) + (progressA.incorrectCount || 0) + 1);
                            const scoreB = (progressB.correctCount || 0) / ((progressB.correctCount || 0) + (progressB.incorrectCount || 0) + 1);
                            return scoreA - scoreB;
                        });
                        characterToTest = allCharacters[0];
                    }

                    const alphabet = await db.alphabets.get(characterToTest.alphabetId);

                    appState.currentCharForTest = characterToTest;
                    appState.incorrectAttempts = 0;
                    appState.caseForTest = Math.random() < 0.5 ? 'uppercase' : 'lowercase';

                    testPrompt.textContent = `Draw the ${appState.caseForTest} letter: "${characterToTest.name}"`;
                    speak(characterToTest.pronunciationKey, alphabet.languageCode);

                    setupCanvas();
                } catch (error) {
                    logger.error("Failed to start the test:", error);
                    testPrompt.textContent = "Error starting test. Please try again.";
                }
            }

            let canvasEventHandlers = null;

            function setupCanvas() {
                const ctx = drawingCanvas.getContext('2d');
                let drawing = false;
                let userStrokes = [];
                let currentStroke = [];

                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                // Remove previous listeners if they exist
                if (canvasEventHandlers) {
                    drawingCanvas.removeEventListener('mousedown', canvasEventHandlers.start);
                    drawingCanvas.removeEventListener('mousemove', canvasEventHandlers.draw);
                    drawingCanvas.removeEventListener('mouseup', canvasEventHandlers.stop);
                    drawingCanvas.removeEventListener('mouseleave', canvasEventHandlers.stop);
                    drawingCanvas.removeEventListener('touchstart', canvasEventHandlers.start);
                    drawingCanvas.removeEventListener('touchmove', canvasEventHandlers.draw);
                    drawingCanvas.removeEventListener('touchend', canvasEventHandlers.stop);
                }

                const startDrawing = (e) => {
                    e.preventDefault();
                    drawing = true;
                    currentStroke = [];
                    const pos = getMousePos(drawingCanvas, e);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                };

                const draw = (e) => {
                    e.preventDefault();
                    if (!drawing) return;
                    const pos = getMousePos(drawingCanvas, e);
                    currentStroke.push(pos);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                };

                const stopDrawing = (e) => {
                    e.preventDefault();
                    if (!drawing) return;
                    drawing = false;
                    if (currentStroke.length > 1) {
                        userStrokes.push(currentStroke);
                    }
                    ctx.closePath();
                };

                // Store handlers to be able to remove them later
                canvasEventHandlers = { start: startDrawing, draw: draw, stop: stopDrawing };

                // Add both mouse and touch event listeners
                drawingCanvas.addEventListener('mousedown', startDrawing);
                drawingCanvas.addEventListener('mousemove', draw);
                drawingCanvas.addEventListener('mouseup', stopDrawing);
                drawingCanvas.addEventListener('mouseleave', stopDrawing);
                drawingCanvas.addEventListener('touchstart', startDrawing);
                drawingCanvas.addEventListener('touchmove', draw);
                drawingCanvas.addEventListener('touchend', stopDrawing);

                const handleSubmit = async () => {
                    const char = appState.currentCharForTest;
                    const caseToTest = appState.caseForTest;

                    const isCorrect = validateStrokes(userStrokes, char.strokeSVGPaths[caseToTest]);

                    try {
                        const progress = await db.userProgress.get({ characterId: char.characterId }) || { characterId: char.characterId, correctCount: 0, incorrectCount: 0 };
                        progress.lastTested = new Date(); // Update lastTested timestamp

                        if (isCorrect) {
                            testFeedback.textContent = 'Correct!';
                            progress.correctCount++;
                            await db.userProgress.put(progress);
                            setTimeout(() => {
                                testFeedback.textContent = '';
                                startTest();
                            }, FEEDBACK_TIMEOUT_MS);
                        } else {
                            appState.incorrectAttempts++;
                            progress.incorrectCount++;
                            await db.userProgress.put(progress);

                            if (appState.incorrectAttempts >= MAX_INCORRECT_ATTEMPTS) {
                                testFeedback.textContent = `Incorrect. Here's a hint.`;
                                characterDisplayContainer.classList.remove('hidden');
                                testingModeContainer.classList.add('hidden');
                                displayCharacter(char.characterId);
                                setTimeout(() => {
                                    setMode('test');
                                    characterDisplayContainer.classList.add('hidden');
                                }, HINT_TIMEOUT_MS);
                            } else {
                               testFeedback.textContent = `Incorrect. Try again.`;
                               setTimeout(() => {
                                    testFeedback.textContent = '';
                                    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                                    userStrokes = [];
                               }, FEEDBACK_TIMEOUT_MS);
                            }
                        }
                    } catch (error) {
                        logger.error("Failed to update user progress:", error);
                    }
                };

                // Remove previous listener before adding a new one
                submitDrawingBtn.removeEventListener('click', submitDrawingBtn.handler);
                submitDrawingBtn.handler = handleSubmit;
                submitDrawingBtn.addEventListener('click', submitDrawingBtn.handler);
            }

            function getMousePos(canvas, evt) {
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
                const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            // --- HANDWRITING VALIDATION LOGIC ---

            function getStrokeEndpoints(svgPath) {
                try {
                    const commands = svgPathParser.parseSVG(svgPath);
                    if (commands.length === 0) return null;

                    svgPathParser.makeAbsolute(commands);

                    const firstCommand = commands[0];
                    const lastCommand = commands[commands.length - 1];

                    // For a Z command, the end point is the start point of the subpath
                    const endPoint = lastCommand.code.toUpperCase() === 'Z'
                        ? { x: lastCommand.x0, y: lastCommand.y0 }
                        : { x: lastCommand.x, y: lastCommand.y };

                    return {
                        start: { x: firstCommand.x0, y: firstCommand.y0 },
                        end: endPoint
                    };
                } catch (error) {
                    logger.error("Error parsing SVG path:", error);
                    return null;
                }
            }

            function arePointsClose(p1, p2, threshold) {
                const dx = p1.x - p2.x;
                const dy = p1.y - p2.y;
                return (dx * dx + dy * dy) < (threshold * threshold);
            }

            function validateStrokes(userStrokes, correctStrokePaths) {
                if (userStrokes.length !== correctStrokePaths.length) {
                    logger.log(`Validation failed: Stroke count mismatch. User: ${userStrokes.length}, Correct: ${correctStrokePaths.length}`);
                    return false;
                }
                if (userStrokes.length === 0) return false;

                const scaleFactor = CANVAS_WIDTH / SVG_VIEWBOX_SIZE;

                for (let i = 0; i < userStrokes.length; i++) {
                    const userStroke = userStrokes[i];
                    if (userStroke.length < 2) {
                        logger.log(`Validation failed: User stroke ${i} has fewer than 2 points.`);
                        return false; // Stroke must have start and end
                    }

                    const correctEndpoints = getStrokeEndpoints(correctStrokePaths[i]);
                    if (!correctEndpoints) {
                        logger.warn(`Could not parse correct endpoints for stroke ${i}: ${correctStrokePaths[i]}`);
                        return false; // Could not parse correct path
                    }

                    const userStartPoint = { x: userStroke[0].x / scaleFactor, y: userStroke[0].y / scaleFactor };
                    const userEndPoint = { x: userStroke[userStroke.length - 1].x / scaleFactor, y: userStroke[userStroke.length - 1].y / scaleFactor };

                    const matchForward = arePointsClose(userStartPoint, correctEndpoints.start, STROKE_VALIDATION_THRESHOLD) && arePointsClose(userEndPoint, correctEndpoints.end, STROKE_VALIDATION_THRESHOLD);
                    const matchReverse = arePointsClose(userStartPoint, correctEndpoints.end, STROKE_VALIDATION_THRESHOLD) && arePointsClose(userEndPoint, correctEndpoints.start, STROKE_VALIDATION_THRESHOLD);

                    if (!matchForward && !matchReverse) {
                        logger.log(`Validation failed on stroke ${i}:`);
                        logger.log('User points (scaled):', { start: userStartPoint, end: userEndPoint });
                        logger.log('Correct points:', correctEndpoints);
                        return false;
                    }
                }

                return true;
            }

            function openStrokeEditor(character) {
                strokeEditorContainer.classList.remove('hidden');
                uppercasePathInput.value = character.strokeSVGPaths.uppercase.join('\n');
                lowercasePathInput.value = character.strokeSVGPaths.lowercase.join('\n');

                const redraw = () => {
                    const upperPaths = uppercasePathInput.value.split('\n').filter(p => p.trim() !== '');
                    const lowerPaths = lowercasePathInput.value.split('\n').filter(p => p.trim() !== '');
                    animateCharacter(handwritingSvgUpper, handwritingSvgLower, { uppercase: upperPaths, lowercase: lowerPaths });
                };

                const closeEditor = () => {
                    strokeEditorContainer.classList.add('hidden');
                    redrawSvgBtn.removeEventListener('click', redraw);
                    closeEditorBtn.removeEventListener('click', closeEditor);
                };

                redrawSvgBtn.addEventListener('click', redraw);
                closeEditorBtn.addEventListener('click', closeEditor);
            }

            // --- Start the application ---
            initializeApp();
        };
    </script>
</body>
</html>
